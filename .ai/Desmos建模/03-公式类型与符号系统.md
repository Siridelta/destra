# 03 - 公式类型与符号系统

> **前置阅读**：请确保您已阅读 [01-声明式系统与并行计算.md](./01-声明式系统与并行计算.md) 和 [02-上下文语句与动态绑定模型.md](./02-上下文语句与动态绑定模型.md)。

本文档旨在归纳和介绍 Desmos 中具体的公式（表达式）类型和符号系统的规则。

## 公式类型

在 Desmos 的声明式模型中，用户输入的每一行“公式”，都是在依赖关系图 (DAG) 中创建或声明节点的一种方式。根据其语法结构，Desmos 会将其识别为不同的类型，并赋予不同的行为和可视化效果。

1.  **纯表达式 (Expression)**
    -   **形式**: `2 + a` (其中 a 已被定义)
    -   **行为**: 声明一个匿名的、可求值的节点。它不创建新的具名符号，其计算结果通常用于在公式列表中直接显示，或作为其他节点的输入。

2.  **变量定义 (Variable Definition)**
    -   **形式**: `a = 3`
    -   **行为**: 声明一个名为 `a` 的新符号节点，并将其与表达式 `3` 的结构关联起来。如果表达式的结果是一个单一数值，通常会附带一个滑动条。

3.  **函数定义 (Function Definition)**
    -   **形式**: `f(x) = x^2`
    -   **行为**: 声明一个名为 `f` 的新符号节点。这是一种特殊的“上下文语句”，它将一个可被调用的结构与符号 `f` 关联起来。

4.  **方程/不等式 (Equation/Inequality)**
    -   **形式**: `x^2 + y^2 = 4`, `y > sin(x)`
    -   **行为**: 声明一个描述了保留符号 `x` 和 `y` 之间关系的节点。这类通常被称为**隐式方程**，因为 `y` 没有被明确表示为 `x` 的函数。Desmos 会自动识别这种关系并绘制其对应的图形。

5.  **可绘制的显式方程 (Plottable Explicit Equations)**
    -   **核心规则**: Desmos 会将任何符合 `因变量 = 只含一个自变量的表达式` 模式的等式，自动识别为可绘制的函数关系。
    -   **具体表现形式**:
        1.  **标准形式 (Canonical Form)**: 使用保留符号 `x`, `y`。
            -   **形式**: `y = expr(x)` 或 `x = expr(y)`。
            -   **要求**: `expr(x)` 中除 `x` 外不能有其他未定义符号；`expr(y)` 同理。
            -   **示例**: `y = a*x^2 + b*x + c` (当 a, b, c 已定义)

        2.  **简写形式 (Shorthand Form)**: 省略 `y =` 部分。
            -   **形式**: `expr(x)`
            -   **行为**: 当一个表达式中唯一的未定义符号是 `x` 时，Desmos 自动将其理解为 `y = expr(x)`。
            -   **示例**: `sin(x)`, `x^3 - x`

        3.  **通用符号形式 (General Form)**: 使用任意未定义的符号作为因变量和自变量。
            -   **形式**: `a = expr(b)`
            -   **行为**: 当等式左边的 `a` 和 `expr` 中唯一的未定义符号 `b` 都是普通符号时，Desmos 会自动将它们映射到坐标轴上进行绘图（等号左侧符号 `a` 映射到 `y` 轴，右侧所依赖符号 `b` 映射到 `x` 轴）。
            -   **示例**: `V = (4/3)*pi*r^3` (当 V, r 未定义)

        4.  **混合形式 (Mixed Form)**: 使用保留符号和通用符号的组合。
            -   **形式**: `y = expr(a)` 或 `x = expr(a)`
            -   **行为**: 当 `a` 是唯一的未定义符号时，Desmos 也会将其作为自变量（映射到 `x` 轴或 `y` 轴）进行绘图。
            -   **示例**: `y = sin(t) + 0.5t` (当 t 未定义时)

6.  **回归 (Regression)**
    -   **形式**: `y_1 ~ m x_1 + b`
    -   **行为**: 这是一种特殊的声明，它会基于已有的数据点（如列表 `x_1`, `y_1`）进行统计计算，然后自动创建新的变量定义节点（如 `m` 和 `b`）来存储拟合参数。

## 符号

Desmos 对构成表达式的符号有着严格的规则。

### 1. 符号的有效形式

-   **基础**: 单个拉丁字母或希腊字母，如 `a`, `b`, `θ`。
-   **下标**: 允许在单个主字符后附加多字符下标，如 `a_1`, `v_{max}`。
-   **技术实现**: Desmos 前端使用 Mathquill 组件，它会将用户输入的公式转换为规范的 LaTeX 代码。因此，Bernard 项目在建模时，主要需要关心如何解析合法的 LaTeX 符号，而无需处理前端的输入错误。

### 2. 特殊符号与保留字

-   **绘图保留字**: `x` 和 `y` 是最核心的保留符号，用于定义二维坐标空间。它们不可被用户重新定义。在 3D 计算器中，`z` 也是保留符号。
-   **参数方程保留字**: 在参数曲线 `(f(t), g(t))` 中，`t` 是一个特殊的保留符号，代表参数。
-   **内置函数**: `sin`, `cos`, `log` 等多字符函数名是预定义的多字符符号，具有最高解析优先级。
-   **内置常量**: `e`, `pi`, `i` (虚数单位，启用复数模式后) 等也是受保护的预定义符号。

### 3. 内置符号的保护机制

Desmos 有一套防止用户意外覆盖内置符号的机制，这体现了其符号解析的优先级：

**内置符号 > 用户定义符号**

-   **覆盖常量**: 尝试 `e = 3` 不会定义一个新变量 `e`，而是会被 Desmos 解析为一个方程 `2.718... = 3`，并判断其为假，不输出。
-   **覆盖函数**: 尝试 `sin(x) = 0.5x` 不会重定义 `sin` 函数，而是会被解析为一个方程绘制其图象（图象为数条竖线，每条竖线横坐标为方程 `sin(x) - 0.5x = 0` 的一个解）
-   **命名空间区分**: Desmos 的符号系统能区分内置符号常量和与其同名的用户定义的函数。因此，定义一个函数 `e(x) = x^2` 是完全合法的，它与内置常量 `e` 并不冲突。
