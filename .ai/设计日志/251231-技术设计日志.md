# 251231-技术设计日志

## 251231：解析器技术选型与功能简化

### 背景
为了在紧迫的时间线（2025年底）内完成 Destra 的核心编译与导出功能，我们需要对原定的技术路线进行调整。原计划中的 Tier 1 正则类型分析 + Tier 2 AST 解析的双层架构虽然稳健，但开发成本过高。同时，为了聚焦核心价值，需要暂时裁剪部分边缘功能。

### 决策 1：采用 Chevrotain 作为解析器核心
放弃手写解析器或简单正则匹配的尝试，选用 **Chevrotain** 构建全功能的 parser。
- **理由**: 高性能、容错性强、TypeScript 支持极佳、文档丰富。
- **应用**: 解析器将直接集成在 `expr` / `expl` 工厂函数的创建流程中。

### 决策 2：架构简化 - 移除 Tier 1 分析
放弃原设计中 "先用正则进行粗略类型推断 (Tier 1)，运行时仅做轻量级检查，开发时再做全量 AST 解析 (Tier 2)" 的策略。
- **新策略**: **全量 AST 优先**。
- **流程**: 
    1.  工厂函数接收模板字符串。
    2.  立即调用 Parser 生成 CST/AST。
    3.  分析 AST 结构以确定 Formula Type（变量定义、函数定义、显式方程、回归等）。
    4.  基于分析结果创建对应的 `Formula` 子类实例。
- **优势**: 消除 Tier 1 与 Tier 2 的一致性维护成本；能够更准确地识别复杂语法（如区分隐式方程与显式方程）。

### 决策 3：功能裁剪与调整
为了加速交付，对 Expr DSL 的语法支持范围做出以下调整：
1.  **裁剪**:
    - **统计检验 (Statistical Tests)**: 暂时移除 ttest, ztest 等复杂统计函数支持。
    - **复杂省括号调用**: 仅支持最基础的省括号调用（如 `sin x`），不支持 Desmos 中复杂的嵌套省括号规则。
    - **微分算子**: 简化为类似上下文语句的结构 `d/dx expr`，不作为独立的高级算子处理。
2.  **新增/补全**:
    - **连乘 (Prod)**: 补全 `prod` 上下文语句，与 `sum` 对齐。
    - **回归参数自动提取**: `Regression` 对象不再是简单的 Expression。当创建如 `y ~ kx + b` 的回归公式时，系统需自动识别出 `k` 和 `b` 为待定参数，并自动创建对应的 `Expl` 对象挂载在返回的 Regression 实例上（如 `reg.k`, `reg.b`），以便用户对其进行重命名 (`.id()`)。
    - **隐式显式方程 (Implicit Explicit Equation)**: 支持 `expr\`x^2\`` 这种无等号写法，自动解析为 `y = x^2` 形式的显式方程（2D模式下仅限依赖 x）。

### 决策 4：占位符处理策略
鉴于 Chevrotain 是基于字符串的 lexer，处理 JS 模板字符串中的对象插值（`${obj}`）需要一种映射机制。
- **策略**: 
    1.  **预处理**: 将模板字符串中的插值位置替换为特殊格式的占位符 Token（例如 `__PH_0__`, `__PH_1__`）。
    2.  **Lexing**: 定义一个 `Placeholder` Token 类型来匹配这些特殊字符串。
    3.  **Parsing/Visiting**: 在构建 AST 时，根据 `Placeholder` 中的索引从原始 `values` 数组中取回对象引用，并嵌入 AST 节点中。

### 影响评估
- **FormulaType**: 需要重构以适应基于 AST 的类型推断。
- **Regression**: 类结构需要变动，增加对参数子对象的持有。
- **Dependencies**: 依赖收集逻辑将从“基于正则提取”变为“遍历 AST 收集”。
