# 251107 技术设计日志：确定表达式解析策略

**参与者**: static, Gemini

**背景**:
在对 `251107-核心重构与功能拆分.md` 计划进行复审时，我们深入讨论了 `expr` / `expl` 工厂函数中表达式模板字符串 (DSL) 的解析时机问题。这是一个关于“开发者体验 (DevEx)”与“运行时性能”的核心权衡。

**讨论的核心问题**:
应该在表达式对象创建时就进行完整解析（“急解析”），还是推迟到最终图表编译时再解析（“懒解析”）？

**tier 1: Analyze Type**

这一级别的解析使用正则表达式简单地确定表达式的大致类型，但不能彻底检查 DSL 是否完全正确合法。

**tier 2: Parse AST**

这一级别的解析使用 AST 解析器对 DSL 进行完整的解析，可以彻底检查 DSL 是否完全正确合法，以及获取 AST 数据结构。

**方案一：急解析 (Eager Parsing)**
- **做法**: 在 `expr`/`expl` 函数内部立即对 DSL 进行 tier 2 级别的 AST 解析。
- **优点**:
    - **快速失败**: 语法错误能立即以异常形式抛出，而且错误更容易定位（可以定位到具体的 DSL 定义位置）。
    - **下游逻辑简化**: 编译时可假定所有表达式对象已合法。
- **缺点**:
    - **创建开销**: 批量创建表达式时可能有效能损耗。
    - **资源浪费**: 库中未被使用的表达式也会被解析，造成浪费。

**方案二：懒解析 (Lazy Parsing)**
- **做法**: `expr`/`expl` 只做 tier 1 级别的浅层分析（如当前的 `analyzeType` 函数实现），将 tier 2 级别的完整解析推迟到最终编译阶段。
- **优点**:
    - **创建迅速**: 表达式对象创建几乎无开销。
    - **高效**: 只有最终进入依赖图的表达式才会被解析。
- **缺点**:
    - **错误反馈延迟**: DevEx 差，简单的语法错误直到最后一步才暴露，难以追溯定位错误。

**IDE 服务**
IDE 服务给这个问题带来了新的变量。或许我们可以，甚至应该在 IDE 语言服务里进行 tier 2 的解析，然后给用户报错。否则，除非用户在 live preview 图表创作模式下工作，否则即使我们在程序本体采用急解析策略，也只能在 ts 编译时、项目构建(build)时报出错误，而无法在开发时、编辑代码时立即报错反馈给用户。

**对“性能开销”的重新审视**

可能我们要重新审视一下对“性能开销”的定义，或者说在 Destra 的使用场景里性能开销会从哪些地方上出现。

- 用户可能会创建极端大量的表达式对象，这会导致创建时/导出时 tier 2 级别的解析成为性能瓶颈。但其实无论如何这个性能开销可能都无法绕过。
- 但是用户有可能会在创建大量表达式对象后抛弃大部分，只保留少量；特别是如果用户使用了其他用户的库，那么或许只需要使用其中很少一部分表达式会是一种很常见的情况。如果是这样的话，创建时 tier 1 级别的解析与创建时 tier 2 级别的解析相比就能节省大量性能开销。
- 用户也有可能创建数量少、但是 DSL 内容长、结构复杂的表达式。这种情况下，在 IDE 语言服务里进行 tier 2 级别的解析与 tier 1 相比会带来更多额外性能开销。但是或许用户不会这么做，或者说，既然你用 Destra 了，为什么还要像在原生界面里创作一样，写很大很长的 DSL 表达式呢？Destra 的一个功能就是可以让你把逻辑拆分成多个表达式，然后通过依赖关系组合起来。所以我们可以鼓励用户不往那个方向去做，然后搁置这方面的性能开销问题。

**最终决策：采纳“运行时懒解析 + 开发时 IDE 插件 Tier 2 解析”的混合策略**

所以我们觉得可以通过 DevEx 工具链来解决上述矛盾，实现两全其美。

1.  **运行时采用“懒解析”：创建时 (Creation Time) tier 1 分析，导出时 (Export Time) tier 2 解析**:
    - `expr`/`expl` 工厂函数只进行 Analyze Type 级别的浅层分析，保证了最高的运行时性能和最低的资源占用。
    - 完整的 Parse AST 级别的解析推迟到 Export Time 时，由一个独立的 Parser 模块负责。

2.  **开发时 IDE 插件实时 Tier 2 解析**:
    - 配套的 Volar 语言服务插件将直接利用 Parser 模块，在开发者编写代码时，对 `expr` / `expl` 模板字符串进行实时的、完整的后台解析。
    - 尽可能的找到任何可能的语法错误，并通过 IDE 的诊断系统（如红色波浪线）立即反馈给开发者。

**结论**:
该混合策略完美地平衡了性能与开发体验。它将重量级的解析工作从浏览器运行时转移到了开发环境中，为用户提供了流畅的创作体验，同时又保证了开发者能够即时发现并修正错误。这一决策将作为后续核心模块重构和工具链开发的重要指导原则。
