# Destra “默认模式”设计方案

> 本文档详细阐述 Destra 项目“默认模式”的具体技术设计。

**默认模式** 是 Destra 库的主要开发方向和推荐使用方式。其核心目标是提供一个**高度封装、专注于表达式组合与复用的工具框架**。它旨在简化 Desmos 图表的构建过程，让用户可以像编写模块化代码一样来组织复杂的数学逻辑。

## 适用场景

适用于需要构建大型、复杂、可维护的 Desmos 图表的开发者，特别是那些希望将软件工程的最佳实践（如模块化、封装、代码复用）应用于数学可视化创作的场景。

## 核心设计决策

为了实现上述目标，默认模式在设计上有明确的取舍，主动放弃了 Desmos 的部分原生特性，以换取更高级别的抽象和更强的工程确定性。

### 1. 依赖管理：禁止悬空依赖

严格禁止任何形式的悬空依赖。一个表达式被创建时，它所依赖的所有符号必须已经定义。这确保了依赖图在任何时候都是完整和确定的，从而简化了分析和计算过程。

### 2. 上下文语句：统一为弱绑定回调模式

为了消除歧义并增强封装性，所有上下文语句（包括原版Desmos中具有强制替换功能的 `with` 和 `for`）都将采用统一的“弱绑定”实现模式。它们只负责为其内部作用域提供局部变量，而不影响任何上游表达式的结构。

推荐的实现语法将采用函数回调的形式，将局部变量通过上下文对象 (`ctx`) 注入：

```javascript
// 'For' 语句创建一个上下文，其中 a=3, b=expr`4`
// 然后将这个上下文作为参数 ctx 传递给回调函数
const c = For`a = 3, b = ${expr`4`}` (ctx => {
    // 回调函数返回一个新的表达式，其中使用了上下文提供的 a 和 b
    // ctx.a 和 ctx.b 是表达式对象，可以被直接嵌入
    return expr`${ctx.a}^2 + ${ctx.b}^2`;
}); 
```
这种模式确保了作用域的清晰隔离，上下文的提供方和使用方权责分明，杜绝了“下游影响上游”的复杂情况。

### 3. 特性范围：专注核心封装与复用

将优先实现命名空间、重命名策略等核心封装机制，暂时放弃对盲文模式等尚不明确或难以建模的高级特性，以确保核心功能的稳定和快速迭代。

### 4. 命名与封装机制：三层命名系统

为了在JavaScript的友好变量名和Desmos的符号限制之间建立桥梁，并提供强大的封装能力，我们引入一个三层命名系统：

-   **JS 变量名**: 用户在JavaScript代码中声明的变量名，如 `myCircleRadius`。预处理功能会根据JS变量名推测 Destra 标识。
-   **Destra 标识 (中间名)**: 一个用户可指定的、支持命名空间的字符串标识，作为在Destra框架下组织表达式系统时的标识ID。
-   **Desmos 真名**: 最终生成到Desmos图表中的、符合其命名規則（通常是单字符+下标）的符号名。

这个系统通过以下API进行操作：

**a. 指定Destra标识:**
使用 `.name()` 方法为表达式对象指定一个中间名。这通常与 `package` 结合使用。
```javascript
// 为一个表达式直接指定Destra标识
const radius = expr`1`.name("myCircle.radius"); 
```

**b. 强制指定Desmos真名:**
使用 `.realname()` 方法可以强制为表达式指定最终的Desmos符号，Destra会尽力转换使其合法化。
```javascript
// 建议Desmos真名为 r_mc
const radius = expr`1`.realname("r_myCircle"); 
```

**c. 包装与命名空间:**
`package()` 函数是实现封装和批量命名的核心。它将一组表达式打包，并可以通过 `.name()` 方法为包内所有未指定中间名的表达式批量赋予带命名空间的Destra标识。
```javascript
const circleDefinition = package([
   expr`center_x = 0`,
   expr`center_y = 0`,
   expr`radius = 1`
]).name("myCircle"); // 为包内所有表达式赋予 "myCircle" 命名空间

// circleDefinition.center_x 的Destra标识将是 "myCircle.center_x"
```
这个机制允许创建可复用的、无命名冲突的组件，是“默认模式”工程化能力的核心。
