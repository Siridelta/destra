# Destra “默认模式”设计方案

> 本文档库详细阐述 Destra 项目“默认模式”的技术设计与核心理念。

**默认模式** 是 Destra 库的主要开发方向和推荐使用方式。其核心目标是提供一个**高度封装、专注于表达式组合与复用的工具框架**。它旨在简化 Desmos 图表的构建过程，让用户可以像编写模块化代码一样来组织复杂的数学逻辑。

## 适用场景

适用于需要构建大型、复杂、可维护的 Desmos 图表的开发者，特别是那些希望将软件工程的最佳实践（如模块化、封装、代码复用）应用于数学可视化创作的场景。

## 核心设计原则

为了实现上述目标，默认模式在设计上有明确的取舍，主动放弃了 Desmos 的部分原生特性，以换取更高级别的抽象和更强的工程确定性。

1.  **禁止悬空依赖**: 严格禁止任何形式的悬空依赖。一个表达式被创建时，它所依赖的所有符号必须已经定义。这确保了依赖图在任何时候都是完整和确定的，从根本上保证了计算图的稳定性和可预测性。

2.  **简化的上下文模型**: 为了消除歧义并增强封装性，默认模式简化了 Desmos 原本复杂的上下文机制，避免了“下游影响上游”的情况，确保了作用域的清晰隔离。

3.  **专注核心封装与复用**: 优先实现命名空间、模块化等核心封装机制，确保核心功能的稳定和快速迭代。

## 设计哲学演进

在遵循以上原则的基础上，经过多个版本的迭代，我们决定在默认模式里先尝试一套**ID 体系动态化**与**工具链增强**的方案（variant 代号：`v-id-mutable`），重点解决模块化分发中的核心挑战。它的主要设计点包括：

-   **拥抱 ID 可变性 (Mutability)**: API 被设计为可变的，ID 操作直接修改对象自身，以在批量操作中维持对象间的依赖引用关系。
-   **ID 体系与文件结构解耦**: 库作者负责主动维护一个稳定的、与物理文件结构**异构**的逻辑 ID 体系，避免因代码重构而破坏下游 API。
-   **工具链增强 DevEx**: 放弃在静态类型中编码所有信息，转而依赖**外部 IDE 插件（Volar）**来动态计算和展示信息，以提升开发者体验。

## 内容目录

为了更好地组织信息，我们将默认模式的设计方案拆分为了以下几个独立的文档，详细阐述其具体实现：

-   **[简化的计算模型](./简化的计算模型.md)**
    -   *内容*：阐述默认模式为保证工程确定性而设定的两大核心约束：禁止悬空依赖，以及将所有上下文语句统一为弱绑定回调模式。
-   **[核心API与命名机制](./核心API与命名机制.md)**
    -   *内容*：详细阐述 v4 方案中的三层 ID 体系、可变的批量 ID 操作 API (`group`, `prefix`)，以及 `builder` API 等核心功能。这是理解默认模式工作原理的基础。
-   **[属性与样式API](./属性与样式API.md)**
    -   *内容*：专门介绍两类属性的不同设计：作为计算图一部分的**不可变** Slider 属性（通过 Expr DSL 定义），以及可动态修改的**可变**显示属性（通过“读写分离”的 Editor 模式进行操作）。
-   **[工具链与开发体验](./工具链与开发体验.md)**
    -   *内容*：描述 Vite 插件、Volar 语言服务、`create-bernard` 脚手架等配套设施如何协同工作，共同构成 Destra 的开发者体验。
-   **[DSL 解析策略](./DSL%20解析策略.md)**
    -   *内容*：详细阐述默认模式中关于表达式 DSL 的核心解析策略，以及其背后的性能与开发者体验 (DevEx) 考量。