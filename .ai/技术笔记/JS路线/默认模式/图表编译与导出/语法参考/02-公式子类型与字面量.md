# 公式子类型与对应字面量语法——完整列举 (Subtypes & Corresponding Literal Syntaxes)

### 1.1 表达式 - 数值 (Expression - Numbers)

#### 1.1.1 数值字面量 (Number Literal)

直接书写数字。支持十进制小数。

支持科学计数法 (E-notation)，例如 `1.2e5`。
*   注意：在 Desmos 中，并没有科学计数法这一独立的“数值字面量”类型，通常使用 `1.2 * 10^5` 这样的算术表达式来表示科学计数法。
*   Destra 为了方便使用，支持在 DSL 中使用科学计数法字面量。在编译时，它会被自动转换为 Desmos 所需的 `数值 * 10 ^ 指数` 的表达式形式。

Desmos 语法：
```
123
3.14159
-0.5
1.2 * 10^5  // 科学计数法在 Desmos 中的实际形态
1.2 * 10^-5
```

Destra 语法：
```javascript
expr`123`
expr`3.14159`
expr`-0.5`
expr`1.2e5`   // 语法糖
expr`1.2E-5`
```

#### 1.1.2 Desmos 内置常量 (Constants)

Desmos 内置的数学常量。

Destra 语法：
- pi ($\pi$): ``expr`pi` ``
- tau ($\tau$): ``expr`tau` ``
- e ($e$): ``expr`e` ``
- 无穷大 ($\infty$): ``expr`infinity` `` / ``expr`infty` ``
- 虚数单位 ($i$): ``expr`i` ``

在 Desmos 里：
- pi ($\pi$): 键盘键入`pi`或直接输入 $\pi$ 符号。
- tau ($\tau$): 键盘键入`tau`或直接输入 $\tau$ 符号。
- e ($e$): 键盘键入`e`。
- 无穷大 ($\infty$): 键盘键入`infinity`或`infty`，或直接输入 $\infty$ 符号。
- 虚数单位 ($i$): 键盘键入`i`。

还有一些不那么数学的常量：

Destra 语法：
- 宽度 (width): ``expr`width` ``
- 高度 (height): ``expr`height` ``

在 Desmos 里：
- 宽度 (width): $\operatorname{width}$。
- 高度 (height): $\operatorname{height}$。

注:

常量支持与前方的数值进行省略乘号的相乘。可以间隔空格，也可以不间隔。

#### 1.1.3 Desmos 保留变量 (Reserved Variables)

例如方程 `x^2 + y^2 <= 1 `中的 x 与 y，在 Desmos 里 x 与 y 这类变量有特殊的作用，它们不能被定义和赋予值，但是可以被引用，在绘制显式方程、隐式方程、隐式不等式等图象的场景里有至关重要的作用。

Destra 可以在 Expr DSL 中直接以字面量形式引用这些保留变量，并且在编译解析时会追踪各个表达式对这些保留变量的依赖情况（例如一个表达式是否依赖 x 或 y）。

Desmos 中的保留变量如下：

- x
- y
- z                        --- 限 3D 计算器
- t
- u                        --- 限 3D 计算器
- v                        --- 限 3D 计算器
- r
- theta ($\theta$)
- rho ($\rho$)             --- 限 3D 计算器
- phi ($\phi$)             --- 限 3D 计算器

Destra 里直接使用上述名称引用即可。

如[核心API与命名机制](../../../核心API与命名机制.md)中所述，在 DSL 内部使用希腊字母 unicode 字符会自动转换并视为对应的希腊字母别名（例如 `θ` -> `theta`）。

### 1.2 表达式 - 点 (Expression - Points)

Desmos 中点由圆括号包裹的元组表示。

Destra 语法：
```javascript
expr`(1, 2)`
expr`(${x}, ${y})`
expr`(1, 2, 3)` // 3D 点
```

Desmos 语法：
```
(1, 2)
(x, y)
(1, 2, 3) // 3D 点
```

### 1.3 表达式 - 列表 (Expression - Lists)

Desmos 强大的列表功能在 Destra 中完全保留。

有数种不同的方法来构造列表。

- **枚举构造**:
  直接写出列表元素。
  - Desmos 语法：
    ```
    [1, 2, 3]
    [a, b, c]
    ```
  - Destra 语法：
    ```javascript
    expr`[1, 2, 3]`
    expr`[${a}, ${b}, ${c}]`
    ```
- **范围构造 (Range)**:
  支持灵活的省略号 `...` 语法。
  - 基本语法：
    - 需要显式指定首项与末项。步长默认为 1。
      - Desmos 语法：`[1, ..., 10]`
      - Destra 语法：``expr`[1, ..., 10]` ``
      - 结果：`[1, 2, 3, ..., 10]`
    - 在首项后面可以显式指定第 2 项，通过这种方式来指定步长。
      - Desmos 语法：`[1, 3, ..., 11]`
      - Destra 语法：``expr`[1, 3, ..., 11]` ``
      - 结果：`[1, 3, 5, 7, 9, 11]`。"1" 和 "3" 决定了步长为 2。
    - 其实“末项”并非严格意义上的末项。这个例子里列表会在陈列到 11 之后停止，会超过“末项”位置上指定的 10，也就是说“末项”位置上的数值表达式指定的更多是一种“终止阈值”，并且会在首次达到或超过该阈值时停止。
      - Desmos 语法：`[1, 3, ..., 10]`
      - Destra 语法：``expr`[1, 3, ..., 10]` ``
      - 结果：`[1, 3, 5, 7, 9, 11]`

  - 其他扩展性语法：
    - 可以在 `...` 前后省略它与数字之间的逗号。
      - Ex.1
        - Desmos 语法：`[1...10]`
        - Destra 语法：``expr`[1...10]` ``
        - 结果：`[1, 2, 3, ..., 10]`
      - Ex.2
        - Desmos 语法：`[1, 3...11]`
        - Destra 语法：``expr`[1, 3...11]` ``
        - 结果：`[1, 3, 5, 7, 9, 11]`
    - 可以插入更多项——但是依然要让列表保持为等差数列。（所以这个特性其实没什么用）
      - Ex.1
        - Desmos 语法：`[2, 4, 6...10, 12, 14]`
        - Destra 语法：``expr`[2, 4, 6...10, 12, 14]` ``
        - 结果：`[2, 4, 6, 8, 10, 12, 14]`
      - Ex.2
        - Desmos 语法：`[1, 1, 1...10, 10, 10]` （尝试指定非等差数列，或分段式的规律）
        - Destra 语法：``expr`[1, 1, 1...10, 10, 10]` ``
        - 结果：报错：“范围必须是等差数列。”

### 1.4 表达式 - 多边形 (Expression - Polygons)

使用多边形函数 `polygon` 创建，作为一种独立的数据类型。`polygon` 函数的详细使用方式在后文介绍，这里简单展示其用例：

- Desmos 语法：`polygon((0, 0), (1, 0), (1, 1), (0, 1))`
- Destra 语法：``expr`polygon((0, 0), (1, 0), (1, 1), (0, 1))` ``
- 结果：一个多边形对象，可绘制出一个正方形。

注：3D 计算器不支持多边形类型。

<!-- Desmos 语法：
```
polygon((0, 0), (1, 0), (1, 1), (0, 1))   // 正方形，传入各个点
polygon([(0, 0), (1, 0), (1, 1), (0, 1)])   // 正方形，传入点列表
polygon(([0, 1, 1, 0], [0, 0, 1, 1]))   // 正方形，传入点列表的另一种写法（我个人在 Desmos 里更习惯这种写法因为能省一些打括号的次数）
```
Destra 语法：
```javascript
expr`polygon((0, 0), (1, 0), (1, 1), (0, 1))`   // 正方形，传入各个点
expr`polygon([(0, 0), (1, 0), (1, 1), (0, 1)])`   // 正方形，传入点列表
expr`polygon(([0, 1, 1, 0], [0, 0, 1, 1]))`   // 正方形，传入点列表的另一种写法
``` -->

### 1.5 表达式 - 颜色 (Expression - Colors)

颜色在 Desmos 中也是一种对象，可用于指定其他图像的颜色样式等。

Desmos 支持多种颜色函数，包括：
- `rgb(r, g, b)`
- `hsv(h, s, v)`，`okhsv(h, s, v)`
- `oklab(l, a, b)`
- `oklch(l, c, h)`
参见 [Custom Colors - Desmos Help Center](https://help.desmos.com/hc/en-us/articles/4406795899533-Custom-Colors)。

Destra 支持以上的颜色函数，同时还支持十六进制颜色字面量，将编译为 rgb 颜色函数调用。
```javascript
expr`rgb(255, 0, 0)`
expr`hsv(0, 1, 1)`
expr`okhsv(0, 1, 1)`
expr`oklab(0, 0, 0)`
expr`oklch(0, 0, 0)`
// Hex 字面量:
expr`#FF0000`    // 将编译为 "rgb(255, 0, 0)" (或者实际上是 `\operatorname{rgb}\left(255,0,0\right)`)
```

也可以构建颜色列表对象：

- Ex.1
  - Desmos 语法：`[rgb(255, 0, 0), rgb(0, 255, 0), rgb(0, 0, 255)]`
  - Destra 语法：``expr`[rgb(255, 0, 0), rgb(0, 255, 0), rgb(0, 0, 255)]` ``
  - 结果：一个颜色列表对象，分别为红色、绿色、蓝色。
- Ex.2
  - Desmos 语法：`hsv([0...360], 0.6, 1)`
  - Destra 语法：``expr`hsv([0...360], 0.6, 1)` ``
  - 结果：一个包含 360 个颜色值的列表对象，呈彩虹色。

颜色列表对象可用于指定列表式图象（如一系列多边形、一系列隐式不等式图形等）的颜色样式。

需要注意，Desmos 会强制要求一个颜色 / 颜色列表对象分配给一个变量（或作为表达式中间值），不允许一个颜色 / 颜色列表对象作为一条公式（“表达式”型）的计算结果而不被分配给一个变量。在 Destra 里等价于不允许一个 Expression 类型的 Expr 对象（而非 Expl 对象）直接接入最终的公式列表。

（但是这个我们其实也控制不了（）因为这玩意也很难静态分析，所以你们自己注意就行（））

<!-- 颜色列表对象也支持所有常规列表操作（见下文）。 -->

### 1.6 表达式 - 布尔值 (Expression - Booleans)

布尔值是比较表达式的结果。在 Desmos 里高度控制布尔值不能“直接出现”，布尔值不能存储为变量，只能作为中间值，必须被接入条件表达式中，但在 Destra 里我们仍然认为布尔值是一种子类型（“表达式”公式类型的子类型），并且可以存储于 Expr (Expression) 中——但你仍然需要后续把它接入条件表达式中。

比较运算符语法在下文介绍，这里简单展示创建布尔值的示例：
- Desmos 语法：`t_ime > 30`
- Destra 语法：``expr`${time} > 30` ``
- 结果：一个布尔值对象，表示时间大于 30。在 Desmos 里如果变量 `t_ime` 的值变为超过 30，则该布尔值为真，否则为假。

也有布尔值列表对象，这里展示一个实际应用示例：
- Desmos 语法：
  ```
  T = 0
  t_marks = [0...30]    // 参照值
  d_rawSquare(C, L) = polygon(C + L * [(1, 1), (1, -1), (-1, -1), (-1, 1)])  // 函数，绘制一个正方形，参数为中心点和边长
  p_rogressBar = { T > t_marks: d_rawSquare((-15 + t_marks, 0), 1) }
  ```
- Destra 语法：
  ```javascript
  const T = expl`0 in 0::`;   // 滑动条连续变化，无上限
  const tMarks = expr`[0...30]`;
  const drawSquare = (C, L) => expr`polygon(${C} + ${L} * [(1, 1), (1, -1), (-1, -1), (-1, 1)])`;
  const progressBar = expr`{${T} > ${tMarks}: ${drawSquare}((-15 + ${tMarks}, 0), 1)}`;
  ```

这里会绘制一个由一排正方形构成的“进度条”，每个正方形代表一个时间点。随着 T 的增长，正方形的数量会逐渐增加，直到达到 30 个。

在这里 ``${T} > ${tMarks}`` 是一个布尔值列表对象，表示时间是否大于 tMarks 中的各个时间点。这个布尔值列表对象会被用于条件表达式中，决定是否绘制对应的正方形。如果 T 大于 tMarks 中的某个时间点，则绘制对应的正方形，否则不绘制（计算为 undefined）。

progressBar 的最终结果是一个多边形列表对象，其中前几个元素为各个真实的多边形，剩余的元素为 undefined。

### 1.7 表达式 - 参数方程 (Expression - Parametrics)

依赖保留变量 t （或 u, v，限 3D 计算器），公式最终计算结果为点 / 点列表类型的表达式，会被绘制为参数方程；但是在错误提示里它仍然视为点类型。

依赖 t 的点类型表达式会被绘制为参数曲线。

依赖 u, v 的点类型表达式会被绘制为参数曲面。

除此之外，使用 for 表达式也可以创建参数方程——这将完全确定它是参数方程。

- Desmos 语法：`(cos a, sin a) for 0 < a < 2pi`
- Destra 语法：``expr`(cos ${a}, sin ${a}) for 0 < ${a} < 1` ``

### 1.8 表达式 - 动作 (Expression - Actions)

动作是一种用于更新 Desmos 变量状态的指令对象，使用它可以创建一些“迭代”，“模拟”主题的图表，甚至可以编写小型程序和游戏。动作可以作为一种“表达式”类型存储于变量中。

使用 `->` 创建动作：
- Desmos 语法：
  ```
  a = 0
  a -> a + 1
  A = a -> 2 * a
  ```
- Destra 语法：
  ```javascript
  const a = expl`0`;
  const action1 = expr`${a} -> ${a} + 1`;
  const action2 = expl`${a} -> 2 * ${a}`.id('A');
  ```
- 结果：
  - a 是一个可以被修改的变量，其初始值为 0。
  - action1 是一个动作对象，可令变量 a 的值加 1。
  - action2 / "A" 是一个动作变量，可令变量 a 的值乘以 2。

优先级: 低于比较运算符，高于逗号。

动作是关于某个变量的赋值操作。Desmos 里可以在公式列表 GUI 界面点击按钮执行已被解析的动作，或者在“计时器”功能里以定时执行动作。

动作可以不赋予变量，也可以赋予变量。

动作类型可以通过逗号连接，表示并联执行：

- Desmos 语法：
  ```
  a = 0
  b = 1
  A = a -> b
  B = b -> a + b
  C = A, B
  ```
- Destra 语法：
  ```javascript
  const a = expl`0`;
  const b = expl`1`;
  const A = expl`${a} -> ${b}`;
  const B = expl`${b} -> ${a} + ${b}`;
  const C = expl`${A}, ${B}`;
  ```
- 结果：
  a, b 为初始值为 0 和 1 的变量，A, B, C 为动作变量，可令变量 a 和 b 的值发生变化。

  需要注意的是，动作为并联执行，每次更新时动作表达式里所参照的变量值为变量被其他动作表达式更新前的值，而非被其他变量表达式更新后的值。可以把 Desmos 变量系统整体看作一个状态机，每执行一次 / 一批动作，状态机就向前进行一次更新 / 迭代。

  执行 C 动作后，a 和 b 的值会交替变化，
  
  执行一次后 a 的值为 1，b 的值为 1；

  执行两次后 a 的值为 1，b 的值为 2；

  执行三次后 a 的值为 2，b 的值为 3；

  执行四次后 a 的值为 3，b 的值为 5；

  不断执行下去，a 和 b 的值会按斐波那契数列增长。

使用逗号连接时，不允许两个目标变量相同的动作表达式连接，否则会报错。例如：
- Desmos 语法：
  ```
  a = 0
  A_1 = a -> a + 1
  A_2 = a -> a + 2
  A = A_1, A_2
  ```
- Destra 语法：
  ```javascript
  const a = expl`0`;
  const A1 = expl`${a} -> ${a} + 1`;
  const A2 = expl`${a} -> ${a} + 2`;
  const A = expl`${A1}, ${A2}`;
  ```
- 结果：尝试解析 A 时会报错，因为两个动作表达式都试图更新变量 a 的值，导致冲突。

### 1.9 表达式 - 提示音 (Expression - Tones)

提示音是一种用于播放正弦波声音的对象。当一个公式的求值结果为一个提示音 / 一个提示音列表时，可以播放该提示音 / 多个提示音。

使用 `tone` 函数创建提示音。第一个参数为频率，第二个参数（可选）为音量。
- Desmos 语法：`tone(440, 1)`
- Destra 语法：``expr`tone(440, 1)` ``
- 结果：一个提示音对象，表示频率为 440 Hz，相对音量为 1 的提示音。点击可以播放该提示音。

可以让提示音依赖于变量，将提示音对象开启播放，然后通过控制变量来实时调制提示音的频率和音量。

如：
- Desmos 语法：
  ```
  T = 0, 滑动条：0:1/12:1
  f = 440 * 2^T
  v = 1
  tone(f, v)
  ```
- Destra 语法：
  ```javascript
  const T = expl`0 in 0:1/12:1`;
  const f = expl`440 * 2^${T}`;
  const v = expl`1`;
  const tone1 = expl`tone(${f}, ${v})`;
  ```
- 结果：播放该提示音，播放 T 的滑动条动画，则频率随 T 的值变化，音量保持不变，可以听出一个上行音阶。

### 1.10 表达式 - 分布 (Expression - Distributions)

分布是一种用于描述概率分布的数学对象。在 Desmos 里，分布可以作为表达式类型存储于变量中。分布的主要用途是用于随机数的生成，或者直接绘制该分布的概率密度图象 / 累计分布图象。

使用各类分布函数创建分布对象，分布函数见下文介绍，这里简单展示一个示例：

- Desmos 语法：
  ```
  normaldist(0, 1)
  ```
- Destra 语法：
  ```javascript
  const dist = expl`normaldist(0, 1)`;
  ```
- 结果：一个分布对象，表示均值为 0，标准差为 1 的正态分布。

### 1.11 统计推断测试 (Expression - Statistical Tests)

新版更新之后这部分变的太复杂了 多引入了好几种子类型和一堆方法式函数。。。。。

反正对我们来说也是边缘功能 暂时不做了（）
