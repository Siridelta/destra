# 技术设计笔记 - 251010

> 本文档汇总 2025-10-10 关于 Bernard.js「默认模式」方案的长对话结论与可执行设计，提炼关键思想、API 走向、DevEx 方案与后续任务。讨论来源于《20251010 monica聊天记录》，并与现有文档体系对齐：`JS路线/JS技术方案.md`、`JS路线/默认模式设计方案.md` 与 `Desmos建模/`。

## 背景与目的

- **项目阶段**: 默认模式为当前主线；Genshin 模式作为远期探索方向。
- **现状对齐**: 保持默认模式对 Desmos 的一致策略：
  - **禁止悬空依赖**；
  - **上下文语句统一为弱绑定**（不允许对上游结构的强制代换）；
  - 暂缓盲文模式等难以建模的特性。

## 结论总览（TL;DR）

- **三层命名系统**：
  - **JS 变量名**：仅是本地别名；不稳定。
  - **Bernard ID**（主键）：全局稳定的字符串 ID；面向跨库与调试。
  - **Desmos 真名**：最终导出到 Desmos 的符号名（受其命名限制）。
- **职责划分**：
  - `.id("...")` 设置 Bernard ID（内部身份，避免跨库冲突）。
  - `.realname("...")` 强制指定最终 Desmos 变量名（冲突应编译期报错）。
- **DevEx 双路径**：
  - 无预处理：标准 JS/TS 即用；以运行时/IDE 插件增强开发体验。
  - 有预处理：通过语言插件（基于 Volar）做构建期增强，但不依赖 TS Transformer API。
- **命名策略抉择**：
  - 蓝图 3.0：约定优于配置，构建期自动注入 ID（与文件路径绑定）。
  - 蓝图 4.0：开发者主动维护异构 ID 体系 + 可变 API + IDE 插件增强。
  - 当前倾向：**采用蓝图 4.0 为默认模式的主方案**（ID 稳定不随文件路径变动，支持高动态生成）。
- **批量 ID 操作与对象模型**：提供 `group(...)`、`builder(...)`、`idprepend(...)` 与 `hoverInfo(...)`；拥抱命令式与动态生成。

## 方案演进（2.0 → 3.0 → 4.0）

### 蓝图 2.0（基础版）

- 三层命名体系明确；`.id()` 赋 Bernard ID，`.realname()` 强制真名；
- 废弃把导出项塞进单对象的 `namespace()/package()` 方案，回归标准 `export`，保留 IDE/JSDoc 全链路体验。

### 蓝图 3.0（构建期自动化）

- 通过预处理器在构建期自动为导出对象注入 ID（约定：`[包名]:[相对文件路径].[导出名]`）。
- 以语言插件（Volar 插件/自定义语言支持）替代不稳定的 TS Transformer API，保证类型推断与 IDE 能力。
- 优点：零手动 ID；缺点：ID 随文件移动而“脱稳”。

### 蓝图 4.0（动态、可塑与工具增强）

- **采纳**：开发者主动维护一套与文件结构可异构的 ID 体系，保障 ID 的跨版本稳定性；
- **API 选择**：**可变 API（mutable）** 以维护对象引用关系与动态性；
- **DevEx 回补**：用 IDE 插件（Volar）提供悬停信息、ID 计算与可视化；
- **动态生成一等公民**：`builder` 支持参数化/批量生成，外部 `idDrvs`（ID 派生）可传入并由生成器内部应用。

## 默认模式 API 草案（方向性）

> 以下 API 面向默认模式的“弱绑定、无悬空依赖、工程化优先”目标，示例均为无预处理形态，便于对照实现。

### 基础构造

```javascript
// 显式声明：在 Desmos 占一行，有名
const c = expl`c = sqrt(${a}^2 + ${b}^2)`;

// 纯表达式片段：可被内联
const e = expr`sqrt(${a}^2 + ${b}^2)`;
```

### 上下文语句（统一弱绑定）

```javascript
// For：仅补全内部所需的局部符号，不影响上游结构
const c = For`a = 3, b = ${expr`4`}`(ctx => expr`${ctx.a}^2 + ${ctx.b}^2`);

// with：在默认模式下亦为弱绑定（仅提供局部引用，不做强制代换）
const y = With`a = ${expr`100`}`(ctx => expr`${b} + ${ctx.a}`);
```

### 命名与冲突策略

```javascript
// 设定 Bernard ID（内部身份）
const u = expl`mylib.core.v = 0`;
const v = expl`0`.id("mylib.core.v");

// 强制设定 Desmos 真名（高优）：冲突时编译期报错
const w = expl`0`.id("keyboard.input.w").realname("w");
```

### 批量 ID 操作与对象模型

```javascript
// 分组：对一组对象集中操作其 ID 派生（可变 API，保持引用）
let a = expl`a = 1`;
let b = expl`b = ${a} + 1`;

const sub = group({ a, b }).idprepend('sub');

// 扁平导出（需要将变量声明为非const）
({ a, b } = sub);
export { 
    a, // JSDoc在此处编写
    b 
}; 

// 动态生成器：生成时自动应用外部传入的 idDrvs（ID 派生规则）
const createPolygons = builder((idDrv) => (
    (count, sides) => {
        // 返回表达式数组；内部对每个项应用 idDrvs 链
    }
));

createPolygons.hoverInfo(({ idDrvs, makeDefaultInfo }) => {
  const example = idDrvs('polygon_1');
  return makeDefaultInfo(`Builder: polygons`, `Example ID: ${example}`);
});

const adv = group({ createPolygons }).idprepend('advanced');
```

### 悬停信息（IDE 插件增强）

```javascript
// 为对象提供自定义 hover 文本（插件将优先调用）
exprOrExpl.hoverInfo(({ id, realname, idInitial, idDrvs, makeDefaultInfo }) => {
  return makeDefaultInfo(id, realname);
});
```

## DevEx 与工具链策略

- **IDE 插件（基于 Volar）**：
  - 悬停展示：`ID / Realname / 自定义说明`；
  - 以安全沙箱“试算”最终 ID（读取 `_internal_id` + `_id_transformations`），或允许库侧提供计算函数绕过重算开销；
  - 兼容标准 ESM 导入导出与 JSDoc，保持跳转与文档体验。
- **编译/导出流程**：
  - 收集所有 `expl`；
  - 检查 `.realname()` 冲突（直接报错）；
  - 为无 `.realname()` 的项基于 Bernard ID 生成可读 Desmos 名并自动消解冲突；
  - 产出最终 Desmos 公式列表。

## 决策与边界

- **已采纳**：默认模式按蓝图 4.0 推进（可变 API + 工具增强 + 弱绑定 + 无悬空依赖）。
- **保留项**：蓝图 3.0 的构建期自动注入 ID 方案作为备选（在可控范围内探索）。
- **不纳入默认模式**：强上下文绑定、盲文模式等；相关能力移交到 Genshin 模式规划。

## 风险与未决问题

- **工具复杂度上移**：IDE 插件成为 DevEx 的关键路径，需要良好沙箱与性能控制。
- **动态生成与 ID 规则**：`builder` 与 `idDrvs` 链的合成/优先级/递归策略需明确定义。
- **多库协作规范**：Bernard ID 前缀建议（如 `npmPackage.segment1.segment2.name`）需形成文档约定。
- **自动 Desmos 命名规则**：可读性与冲突消解之间的平衡（后缀、缩写策略）。

## 后续推进事项与任务清单（起）

1. 产出最小运行时接口（无预处理版）：`Expl/Expr`、`group`、`builder`、`idDrvs` 数据结构与行为草案。
2. 设计 `hoverInfo` API 形状与默认实现；定义插件与库的协作协议（可选自定义计算函数）。
3. 明确 Desmos 真名生成与冲突消解规则；实现 `.realname()` 冲突检查与报错路径。
4. 编译器原型：从 `Expl` 集合生成 Desmos 公式列表（顺序、依赖、属性位点）。
5. Volar 插件 Spike：悬停信息、导入追踪、沙箱求值验证。
6. 同步更新 `JS路线/默认模式设计方案.md` 要点，纳入蓝图 4.0 的 API 粗案与工具路径。

---

### 参考链接

- `JS路线/JS技术方案.md`
- `JS路线/默认模式设计方案.md`
- `Desmos建模/`
- `imported/20251010 monica聊天记录.md`


