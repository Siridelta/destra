# DSL 解析策略

> 本文档阐述 Destra “默认模式”中关于 Expr DSL (领域特定语言) 的核心解析策略，以及其背后的性能与开发者体验 (DevEx) 考量。

## 1. 核心挑战 & 不同程度的解析任务

在设计 `expr` 和 `expl` 这两个核心工厂函数时，我们面临一个关键抉择：**应该在何时对模板字符串中的数学表达式进行解析？** 
很容易想到我们或许可以把解析任务推迟到最终导出时进行，这样或许可以获得更好的性能。但是即使这样，在创建表达式时也需要对 Expr DSL 内容进行一些分析，以判断其类型从而创建正确的表达式/公式对象。

所以我们把解析任务区分成了两个层级（“Tier”）：

-   **Tier 1: 类型分析 (Analyze Type)**
    -   **方式**: 使用正则表达式对表达式进行浅层扫描。
    -   **目标**: 快速判断表达式的大致类型（如变量、函数、方程），但不保证其内部语法的完全正确性。

-   **Tier 2: 完整解析 (Parse AST)**
    -   **方式**: 使用完整的 AST 解析器对表达式进行深度分析。
    -   **目标**: 验证语法的完全正确性，并生成可供后续处理的抽象语法树 (AST) 数据结构。

Tier 2 的解析任务量是包括了 Tier 1 的解析任务量的，同时也是解析任务的“全量”。

基于这两个层级，我们可以更清晰地权衡“急解析”与“懒解析”的利弊。

## 2. 解决方案：运行时懒解析 + 开发时 IDE 插件 Tier 2 解析

为了同时获得最佳的性能和顶级的开发者体验，Destra 采用了一种创新的**混合解析策略**，在不同的时间和环境执行不同层级的解析。

### 2.1 运行时：懒解析保证高性能

在用户的浏览器或 Node.js 环境中，Destra 的核心库遵循**懒解析**原则。

-   **创建时 (Creation Time)**: `expr` 和 `expl` 函数在被调用时，仅进行 **Tier 1** 级别的**类型分析**。
-   **导出时 (Export Time)**: 完整的 **Tier 2** 级别的 **AST 解析**被推迟到最终调用 `destra.export()` 时，并且只对那些实际需要被渲染到图表中的表达式进行。
-   如果用户在 IDE 环境之外，又想更好的定位错误，我们可以提供一个 `Formula.parseAdvance()` 方法，用于手动提前进行 Tier 2 解析，报错，并缓存结果直至用户导出图表。

这确保了：
-   **创建迅速**: 表达式对象的创建几乎没有性能开销。
-   **资源节约**: 永远不会浪费 CPU 周期去对那些未被最终用到的代码进行重量级的 Tier 2 解析。

### 2.2 开发时：IDE 插件实时 Tier 2 解析

为了弥补开发时没有及时的彻底的 Tier 2 解析反馈给用户的缺陷，我们需要利用 **IDE 插件 (基于 Volar)** 来进行实时 Tier 2 解析，并立即反馈给用户。

> 注意，不是“开发时急解析”，其实懒解析/急解析的区分只在程序本体/运行时/构建时有效，因为只有在程序本体里才有推迟解析任务的空间。在 IDE 环境里，我们实际上是在进行实时 Tier 2 解析。

-   **开发时 (Development Time)**: 当开发者在编辑器中编写代码时，插件会在后台**实时地**对 `expr` 和 `expl` 模板字符串进行 **Tier 2** 级别的**完整解析**。
-   一旦检测到任何语法错误，插件会立即通过编辑器的诊断系统（例如，显示红色波浪线）向开发者报错。

这种方式将重量级的 Tier 2 解析工作从最终用户的运行时环境，转移到了开发者的本地开发环境中，实现了完美的平衡。

## 3. 统一的解析器核心

为了确保运行时和开发时 Tier 2 解析逻辑的绝对一致，这两个环境将共享同一个独立的、精心设计的**解析器模块**。

-   图表编译器 (`destra.export()`) 在导出时会调用此模块进行 Tier 2 解析。
-   IDE 插件会直接依赖此模块进行实时的 Tier 2 解析和错误诊断。

通过这种架构，Destra 得以为用户提供一个既“快”又“稳”的创作环境：“快”在最终的运行性能，“稳”在可靠、即时的开发时错误反馈。
