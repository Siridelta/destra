> 本文档详细阐述了 Destra.js 项目为支持多版本并行开发而设计的工程化方案，核心采用 Monorepo 架构与 pnpm workspaces。

## 工程化与多版本并行开发方案-旧版

为了支持默认模式下多个探索性方案（如ID可变版、ID不可变版、类JSX版等）的并行开发，我们决定采用 **Monorepo** 架构，并使用 **pnpm workspaces** 作为核心管理工具。这套方案允许我们在一个代码库中维护多个独立的、可互相引用的包，同时保持清晰的结构和高效的依赖管理。

### 核心目录结构

项目将在 `Destra.js` 文件夹下采用一种按功能划分的、多层级的目录结构，取代传统的单一 `packages` 文件夹模式。这种结构通过顶层文件夹对不同类型的包进行了语义上的分组，使代码库的意图更加明确。

```plaintext
.
├── shared/
│   # 存放所有版本和模块共享的通用代码包
│   ├── core/      # @ad-destra/core: 核心数据结构、算法等
│   ├── types/     # @ad-destra/types: 共享的TypeScript类型定义
│   └── preprocessor/ # @ad-destra/preprocessor: "创作形式"到"标准形式"的代码预处理器
│
├── variant-drafts/
│   # 存放所有并行的、探索性的Destra.js核心实现
│   ├── v-mutable/  # @ad-destra/v-mutable: 可变ID方案
│   └── v-immutable/ # @ad-destra/v-immutable: ID不可变方案
│
├── facade/
│   # 存放最终面向用户的、作为"门面"的包
│   ├── destra/               # @ad-destra/destra: 主库包, 重新导出某个variant
│   ├── vite-plugin-destra/   # @ad-destra/vite-plugin: 配套的Vite插件
│   └── create-destra/        # @ad-destra/create-destra: 项目脚手架CLI
│
├── tooling/
│   # 存放开发时辅助工具，如IDE插件
│   ├── language-server/ # @ad-destra/language-server: Volar语言服务核心
│   └── vscode-extension/  # @ad-destra/vscode-extension: VS Code插件封装
│
├── package.json               # Monorepo 根目录的 package.json
└── pnpm-workspace.yaml        # pnpm 工作区的配置文件
```

暂时使用`@ad-destra`组织名，未来可能迁移到`@destra`组织名；见[251016-命名设计日志](../../设计日志/251016-命名设计日志.md)。

### pnpm Workspaces 配置

为了让 pnpm 能够识别并管理上述结构中的所有包，根目录下的 `pnpm-workspace.yaml` 文件将进行如下配置：

```yaml
packages:
  # 告诉 pnpm 去这几个文件夹下寻找所有的子包
  - 'shared/*'
  - 'variant-drafts/*'
  - 'facade/*'
  - 'tooling/*'
```

### 版本切换与默认导出机制

`facade/destra` 包是最终发布给用户的主包 `destra`，它本身不包含核心实现。它作为一个"代理"或"门面"，其唯一职责是选择一个 `variant-drafts` 中的实现，并将其API重新导出。

通过修改 `facade/destra/package.json` 中的依赖项，就可以切换整个项目对外暴露的"默认版本"，例如：

```json
{
  "name": "destra",
  "dependencies": {
    // 当前选择 v4-mutable 作为默认实现
    "@ad-destra/v4-mutable": "workspace:*"
  }
}
```

同时需要修改 `facade/destra/src/index.ts` 文件，将默认导出改为选择一个 variant 包的导出。
```typescript
export * from "@ad-destra/v-mutable";
```

这种结构为项目的多方案探索提供了强大的工程化支持，保证了不同版本开发的隔离性、代码共享的便利性以及最终版本发布的灵活性。

### 依赖关系流

我们将包组织在不同的顶级目录中，整个 monorepo 内存在一个依赖关系图。

我们可以建立一个大致的**分层心智模型**来理解主要的依赖方向：
1.  **`shared/` (最上游)**: 提供最基础的、无依赖的工具和类型。
2.  **`variant-drafts/`**: 依赖 `shared/` 中的包，实现各种核心逻辑。
3.  **`facade/`**: 依赖 `variant-drafts/` 中的某个具体实现。
4.  **`tooling/` (最下游)**: 依赖 `facade/` 中的主包 `destra` 来获取API信息。

然而，存在必要且健康的**跨层依赖**。例如：
- `@ad-destra/vite-plugin` (`facade/`) 和 `@ad-destra/language-server` (`tooling/`) 都需要直接依赖 `@ad-destra/preprocessor` (`shared/`) 来处理用户代码。

只要我们避免出现循环依赖，这种灵活的DAG结构就是非常健壮的。
