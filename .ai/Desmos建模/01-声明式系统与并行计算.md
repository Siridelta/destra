# 01 - 声明式系统与并行计算

本文档介绍 Desmos 公式系统的基础——它的声明式特性。理解这一点，是后续所有深入分析的前提。

## Desmos 的世界观：声明，而非指令

在 JavaScript 等传统语言中，代码是一系列**指令(Instructions)**，被逐行执行。`let y = x + 1` 的意思是“立即计算 `x + 1` 的**值**，并将这个**结果**存入名为 `y` 的存储空间”。

而在 Desmos 中，公式列表中的每一行都是一个**声明(Declaration)**。`y = x + 1` 的意思是“在此声明 `y` 与 `x + 1` 之间存在一个永恒的**关系**”。Desmos 并不立即计算，而是构建一个关系网络。

这个网络是一个**有向无环图 (DAG, Directed Acyclic Graph)**，其中每个符号（如 `x`, `y`）和表达式都是图中的节点。

## 并行计算模型

由于 Desmos 的声明式特性，公式列表中的所有公式在逻辑上都是**并行存在**的，它们的书写顺序除了影响视觉上的层叠外，不影响计算逻辑。

你可以想象，当任何一个节点（比如一个滑块 `x`）的值发生变化时，这个变化会瞬间沿着 DAG 中所有依赖它的路径传播出去，所有相关的节点都会**同时**进行重新计算，并更新自己的状态。整个系统像一张巨大的电子表格，牵一发而动全身。

### 模型的不同表征：DAG 与 双表/SLP

我们所讨论的 Desmos 声明式模型，可以通过几种等价的视角来观察和理解，我们称之为**表征 (Representations)**。它们是从不同角度对同一个核心事实的描述，并无主次之分。

1.  **依赖关系图 (DAG) 表征**
    -   这是一个**关系视角**的表征。它将每个符号和表达式看作图中的一个节点，节点之间的有向边表示它们之间的依赖关系（箭头从被依赖项指向依赖项）。
    -   这个表征非常适合用来理解当一个值（如滑块）发生变化时，变更是如何在整个系统中**传播**的。

2.  **双表 / 直线程序 (SLP) 表征**
    -   这是一个**结构视角**的表征，更接近于 Desmos 的界面表现和计算机的内部存储。它由两个部分组成：
    -   **公式列表 (Formula List)**: 用户在界面上看到的、从上到下排列的公式。这本质上是一系列不含循环的赋值语句，因此在符号计算领域被称为“直线程序 (Straight-Line Program)”。
    -   **符号表 (Symbol Table)**: 一个索引，它将每个具名符号（如 `a`, `f`）映射到它在公式列表中被定义的位置。

**示例：两种表征的对比**

假设我们在 Desmos 中有以下三行公式：
```
a = 2
b = a + 1
c = a + b
```

-   **在双表/SLP表征下，它看起来像这样：**
    -   **公式列表**:
        1.  `... = 2`
        2.  `... = (对 #1 的引用) + 1`
        3.  `... = (对 #1 的引用) + (对 #2 的引用)`
    -   **符号表**:
        -   `a` -> 指向列表 #1
        -   `b` -> 指向列表 #2
        -   `c` -> 指向列表 #3

-   **在DAG表征下，它看起来像这样：**
    ```
          (a = 2)
          /     \
         /       \
        V         V
    (b = a+1) --> (c = a+b)
    ```
    在这个图中，我们可以清晰地看到 `c` 同时依赖于 `a` 和 `b`，而 `b` 又依赖于 `a`。



## 唯一的“指令”：Actions

Desmos 系统中唯一接近“指令”概念的是 **Actions**。一个 Action 可以被用户点击触发，它的作用是**原子性地更新一个或多个变量的状态**。

例如，一个 Action 可以定义为 `a -> a + 1, b -> 0`。当它被触发时，Desmos 会执行一次状态转换：计算 `a+1` 的新值赋给 `a`，同时将 `b` 设为 `0`。这个更新被视为一个独立的、瞬时完成的事件。在这次更新完成后，新的状态会再次沿着整个 DAG 传播，更新所有依赖 `a` 和 `b` 的公式。

理解 Actions 的关键在于，它本身不是计算过程的一部分，而是**触发计算的外部事件**。系统在两次 Action 之间处于一个稳定的、由声明式关系定义的平衡状态。