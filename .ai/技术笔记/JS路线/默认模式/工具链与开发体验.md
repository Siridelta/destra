# 工具链与开发体验 (DevEx)

> 本文档详细阐述 Destra “默认模式”的开发者体验 (DevEx) 设计理念，以及支撑这一理念的工具链体系。

Destra “默认模式”的设计哲学是，一个优秀的库不仅要有强大的功能，更要提供到位的开发者体验。我们选择不重新发明轮子，而是深度融入现代 JavaScript 生态，将 Destra 定位为一个标准的 **JavaScript 库**和 **Vite 插件**，而非一个大包大揽的自定义框架。

## 1. "Library" 思路 vs "Toolkit" 思路

我们最终采纳了 **"Library" 思路**，这一定位更类似 React (`@vitejs/plugin-react`) 或 Vue (`@vitejs/plugin-vue`)。而“Toolkit”思路则更类似 Next.js (`next` CLI)。

-   **优势**: 完全拥抱 Vite 生态，开发者使用他们已经熟悉的 `vite` 命令，学习成本低，灵活性和透明度最高。
-   **权衡**: 为了解决 `vite.config.js` 等初始配置可能带来的上手门槛，我们提供了一个独立的轻量级脚手架工具 `create-destra`。

## 2. 工具链体系

Destra 的开发者体验由一个分工明确、协同工作的工具链体系支撑，它们共同构成了 Destra 的开发者体验。

*   **核心能力模块**
    *   **预处理器 (Preprocessor)**: 这是一个核心的“幕后”能力模块，负责将开发者编写的、简洁的 **“创作形式 (Authoring Form)”** 代码（如 ``const c = expl`...` ``），转换为系统内部使用的、信息完备的 **“标准形式 (Canonical Form)”** 代码（如 ``const c = expl`...`.id("c", true)``）。它本身不直接面向开发者，而是作为一项基础能力被其他工具调用。

*   **开发者工具集成**
    *   **Vite 插件 (Vite Plugin)**: 在 Vite 构建或开发服务器运行时，调用**预处理器**，对项目源码进行实时转换。
    *   **Volar 语言服务 / IDE 插件**: 这是保障开发者体验的核心。它在代码编辑器中实时调用**预处理器**的分析功能，为开发者提供丰富的代码智能体验，包括：
        *   **悬停信息动态计算**: 动态计算并显示悬停信息，主要用于预览性地计算表达式的 Destra ID。
        *   **自定义悬停信息**: 支持库作者通过 `.hoverInfo()` API 提供更丰富的文档。这是对采用可变 ID 方案后，静态类型系统无法追踪最终 ID 的核心补偿机制。关于 `.hoverInfo()` 的详细用法，请参考 [核心API与命名机制](./核心API与命名机制.md) 文档。
        *   **自动补全**、**代码跳转**等。
    *   **`create-destra` CLI**: 一个独立的轻量级脚手架工具（通过 `npm create destra@latest` 使用）。其**唯一职责**是根据用户的选择（例如“创建一个公式库”或“创建一个静态图表项目”），快速生成一个预设好所有配置的项目模板。
    *   **PSADestra 集成模块**: 未来用于将 Destra 的开发体验无缝集成到 PerSpatia.Ad: Destra 画布环境中的一系列模块。尚未确定。

*   **底层框架与工具**
    *   **Vite**: 作为项目构建、打包和运行开发服务器的基础工具。
    *   **Volar**: 作为开发 IDE 插件和语言服务的底层框架。

## 3. 核心开发场景

我们支持以下几种核心的开发场景，开发者可以通过标准的 Vite 命令与之交互：

1.  **程序化图表构建 (Programmatic Graph Build)**
    *   **描述**: 在 JavaScript 运行时（如 Node.js 或浏览器应用）中，直接调用 Bernard 库提供的 API 来动态构建图表。这个场景的特点在于它不依赖 Vite 插件等构建时工具，不是使用指令构建，而是调用 JS API 来构建。
    *   **产物**: 内存中的 Desmos State Object。

2.  **宿主应用构建 (Host Application Build)**
    *   **描述**: 这是"程序化图表构建"的一个衍生场景。当开发者在一个会被 Vite 打包的宿主应用（如一个前端项目）中，以"创作形式"编写图表构建逻辑，并使用 JS API 来动态构建图表时，依然需要 Vite 插件在宿主应用构建阶段介入，对这部分代码进行预处理。
    *   **产物**: 宿主应用的一部分，内含被正确处理的 Bernard 逻辑。
    *   **命令**: `vite build`

3.  **静态图表构建 (Static Graph Build)**
    *   **描述**: 开发者编写一个或多个定义图表的源文件，并通过命令行调用 Vite 构建指令，将这些源文件编译成一个独立的、可分发的 Desmos State JSON 文件。
    *   **产物**: `.desmos.json` 格式的 Desmos State 文件。
    *   **命令**: `vite build --mode graph`

4.  **公式库开发与打包 (Expression Library Development & Packaging)**
    *   **描述**: 库作者创建一套可复用的公式、函数或图表组件，并利用 Bernard 的模块化和命名机制进行组织，最终通过 Vite 打包成一个标准的 npm 包进行分发。
    *   **产物**: 一个 npm 包。
    *   **命令**: `vite build` (配合 `vite.config.js` 中的库模式配置)

5.  **图表实时预览与开发 (Live-Preview Graph Development)**
    *   **描述**: "静态图表构建"的衍生场景，开发者在本地运行一个由 Vite 驱动的开发服务器。当修改图表源代码时，可以在浏览器中实时看到更新后的图表预览，享受所见即所得的开发体验。
    *   **产物**: 一个本地运行的、带实时预览的 Web 服务。
    *   **命令**: `vite dev --mode graph`

6.  **Desmos Canvas 中开发 (Development in Desmos Canvas)**
    *   **描述**: 在 Desmos Canvas 的画布环境中，通过内嵌的代码节点和图表预览节点，实现 Bernard 代码的编写、运行与可视化，形成一个闭环的、可视化的编程体验。
    *   **产物**: Desmos Canvas 中的 Bernard JS 对象数据、Desmos State Object 数据，以及一些调试服务。
