> 本文档详细阐述了 Destra.js 项目为支持多版本并行开发而设计的工程化方案，核心采用 Monorepo 架构与 pnpm workspaces。

## 工程化与多版本并行开发方案

为了支持默认模式下多个探索性方案（如ID可变版、ID不可变版、类JSX版等）的并行开发，我们决定采用 **Monorepo** 架构，并使用 **pnpm workspaces** 作为核心管理工具。这套方案允许我们在一个代码库中维护多个独立的、可互相引用的包，同时保持清晰的结构和高效的依赖管理。

## 核心设计哲学：为快速探索而优化

Destra.js 项目当前处于一个高度探索性的阶段，我们可能需要同时推进多个技术方案（我们称之为 `Variant`），并对它们进行快速迭代和验证。为了最大化这一阶段的开发效率和灵活性，我们的工程化方案围绕以下核心原则构建：

1.  **Variant 的独立性与隔离性 (Independence & Isolation)**
    每个 `variant` 都被视为一个完全独立的、自包含的项目。这给予了每个方案最大的演进自由，其 API、依赖甚至工具链都可以独立决策，而不必被一个尚不成熟的共享包所限制。

2.  **推迟抽象 (Postpone Abstraction)**
    我们刻意避免在早期阶段提取`shared`或`tooling`这样的共享包。当不同 `variant` 之间需要复用逻辑时，我们优先采用简单的代码复制。只有当多个 `variant` 中自然浮现出稳定、通用的代码模式时，才是提取共享库的最佳时机。这能有效避免过早抽象带来的僵化和维护成本。

3.  **聚焦核心逻辑 (Focus on Core Logic)**
    这套方案旨在将我们的精力从维护复杂的工程结构中解放出来，更专注于每个 `variant` 内部核心功能的快速原型设计和验证。

## 核心目录结构

基于以上原则，我们采用了以下一种更加扁平化和清晰的 Monorepo 目录结构：

```plaintext
.
├── variant-drafts/
│   ├── v-id-mutable/            # @ad-destra/v-id-mutable: ID可变方案
│   │   ├── src/                 # 核心逻辑
│   │   ├── vite-plugin/         # Vite插件 (可选)
│   │   ├── language-server/     # Volar语言服务核心 (可选)
│   │   ├── vscode-extension/    # VS Code插件封装 (可选)
│   │   └── package.json         # variant 的 package.json
│   │
│   └── v-id-immutable/          # @ad-destra/v-id-immutable: ID不可变方案
│       └── ...
│
├── facade/
│   # 存放最终面向用户的、作为"门面"的包
│   ├── destra/                  # @ad-destra/destra: 最终发布的主包，选择并重新导出某个 variant
│   ├── vite-plugin/             # @ad-destra/vite-plugin: 配套的Vite插件
│   ├── create-destra/           # @ad-destra/create-destra: 项目脚手架CLI
│   ├── language-server/         # @ad-destra/language-server: Volar语言服务核心
│   └── vscode-extension/        # @ad-destra/vscode-extension: VS Code插件封装
│
├── package.json                 # Monorepo 根目录的 package.json
└── pnpm-workspace.yaml          # pnpm 工作区的配置文件
```

暂时使用`@ad-destra`组织名，未来可能迁移到`@destra`组织名；见[251016-命名设计日志](../../设计日志/251016-命名设计日志.md)。

## pnpm Workspaces 配置

相应的，根目录下的 `pnpm-workspace.yaml` 文件也进行简化，只管理 `variant-drafts` 和 `facade` 两个目录下的包：

```yaml
packages:
  # pnpm 在以下目录中寻找所有子包
  - 'variant-drafts/*'
  - 'facade/*'
```

## 版本切换机制

`facade/destra` 包是最终发布给用户的主包 `destra`，它本身不包含核心实现。它作为一个"代理"或"门面"，其唯一职责是选择一个 `variant-drafts` 中的实现，并将其API重新导出。

通过修改 `facade/destra/package.json` 中的依赖项，就可以切换整个项目对外暴露的"默认版本"，例如：

```json
{
  "name": "destra",
  "dependencies": {
    // 当前选择 v-id-mutable 作为默认实现
    "@ad-destra/v-id-mutable": "workspace:*"
  }
}
```

同时需要修改 `facade/destra/src/index.ts` 文件，将默认导出改为选择一个 variant 包的导出。
```typescript
export * from "@ad-destra/v-id-mutable";
```

## 未来演进

这套精简的架构是为项目当前的探索阶段量身定做的，它并非永久性的。当项目发展到更成熟的阶段，某个 `variant` 成为事实上的标准，或者多个 `variant` 之间出现了明确且稳定的共享需求时，我们可能会参考[旧版工程化方案](./工程化与多版本并行开发方案-旧版.md)，重新引入 `shared` 目录来存放公共的库和工具。但这一步将在需求明确之后，而非之前。